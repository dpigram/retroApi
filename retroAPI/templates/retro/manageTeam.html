{% extends "retro/baseNavigation.html" %}

{% block pageTitle %}
  {% if team_details %}
    {{team_details.name}}
  {% else %}
      No Team Name Provided
  {% endif %}
{% endblock %}


{% block pageDiscription %}
  
{% endblock %}

{% block localScripts %}
  <script type="text/javascript">
    $(document).ready(function(){
      
      $("#user_search").on('input', function(){
        $.ajax({
            type: "GET",
            url: "/search/users/",
            data: $("#user_search").serialize(),
            beforeSend: function (){
              console.log("sending");
            },
            success: function(data){
              var html = "";
              for(var index in data){
                html += "<tr><td>"+data[index].first_name +" "+data[index].last_name+"</td><td>"+ data[index].username +"</td><td>"+ data[index].email+"</td><td><button class=\"btn btn-link\" id=\""+data[index].id+"\"><span class=\"fa fa-plus\"></span></button><td></tr>";
              }

              $("#search_results_list").html(html);
            },
            error: function(error){
             console.log(error);
            },
            complete: function(){
              console.log("completing");
            }
          });
      });

      function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie != '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = jQuery.trim(cookies[i]);
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) == (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      
      $("table").on("click","#search_results_list tr td button", function(){
        $.ajax({
          type: "POST", 
          url: "/add/teamMember/",
          data: "userId="+$(this).attr("id")+"&teamId={{team_details.id}}",
          beforeSend: function(xhr, settings) {
            function getCookie(name) {
              var cookieValue = null;
              if (document.cookie && document.cookie != '') {
                  var cookies = document.cookie.split(';');
                  for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                  }
               }
               return cookieValue;
            }
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
              // Only send the token to relative URLs i.e. locally.
              xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
          }, 
          success: function(data){
            console.log(data);
          },
          error: function(error){
            console.log(error);
          },
          complete: function(){
            console.log("teamMember call complete");
          }
        });
        console.log("userid: " + $(this).attr("id"));
        console.log("teamId: {{team_details.id}}");
      });
    });
  </script>
{% endblock%}
{% block content%}
  {% if team_details %}
  <div class="row">
    <div class="col-md-5">
      <form method="post" id="team_data">
        <div class="row">
          <div class="col-md-12">
            <div class="form-group">
              <label for="name">Team Name</label>
              <input type="text" name="name" class="form-control">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="form-group">
              <label for="description">Team Description</label>
              <textarea name="description" class="form-control">
                
              </textarea>
            </div>
          </div>
        </div>
      </form>
      <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header">
                Members
              </div>
              <div class="card-body">
                <table class="table table-striped">
                  <tbody>
                    {% for member in team_details.members.all %}
                    <tr>
                      <td>{{member.first_name}} {{member.last_name}}</td>
                      <td><a href="mailto:{{member.email}}">{{member.email}}</a></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
    </div>
    <div class="col-md-1">
      
    </div>
    <div class="col-md-6">
      <div class="row">
        <div class="col-md-12">
          <div class="input-group input-group-lg form-group">
            <span class="input-group-addon">@</span>
            <input type="search" name="member_search" class="form-control" placeholder="Add Member" id="user_search">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div id="search_results">
            <table class="table table table-striped" id="search_results_table">
              <tbody id="search_results_list">
                
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
    <form action="{% url 'retro:deleteTeam' %}" method="post">
      {% csrf_token %}
      <input type="hidden" name="teamId" value="{{team_details.id}}">
      <input type="submit" class="btn btn-danger" value="Delete Team"/>
    </form>
  {% endif %}
{% endblock %}

{ % endblock % }
